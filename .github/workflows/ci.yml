name: CI

on:
  pull_request:
    branches: [ main, develop ]
    paths:
      - '.devcontainer/**'
      - 'Dockerfile'
      - 'packages.repos'
      - '.github/workflows/**'
  
  workflow_dispatch:

jobs:
  test-devcontainer:
    runs-on: ubuntu-latest
    name: Test Devcontainer Build
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up CI environment
        run: |
          chmod +x .devcontainer/host-setup.sh
          export CI=true
        
      - name: Build and test devcontainer
        uses: devcontainers/ci@v0.3
        with:
          imageName: ros2-devcontainer
          env: |
            CI=true
            GITHUB_ACTIONS=true
          
          runCmd: |
            echo "========================================="
            echo "Testing ROS2 Devcontainer"
            echo "========================================="
            
            # Check ROS installation
            echo -e "\n[1/5] Checking ROS installation..."
            source /opt/ros/${ROS_DISTRO}/setup.bash
            ros2 --version
            
            # Check workspace structure
            echo -e "\n[2/5] Checking workspace structure..."
            ls -la /home/rosdev/ros_ws/
            
            # Check scripts exist
            echo -e "\n[3/5] Checking scripts..."
            ls -la /home/rosdev/ros_ws/scripts/
            ls -la /home/rosdev/ros_ws/scripts/core/
            
            # Test environment configuration
            echo -e "\n[4/5] Testing environment..."
            source /home/rosdev/ros_ws/scripts/core/config.sh
            echo "ROS_DISTRO: $ROS_DISTRO"
            echo "WORKSPACE_ROOT: $WORKSPACE_ROOT"
            echo "ROS_DOMAIN_ID: $ROS_DOMAIN_ID"
            
            # Verify no X11 in CI
            echo -e "\n[5/5] Verifying CI configuration..."
            if [ -f /home/rosdev/.Xauthority ]; then
              echo "ERROR: .Xauthority should not exist in CI"
              exit 1
            fi
            
            if [ -d /tmp/.X11-unix ]; then
              echo "ERROR: X11 socket should not exist in CI"
              exit 1
            fi
            
            echo -e "\n========================================="
            echo "All tests passed!"
            echo "========================================="